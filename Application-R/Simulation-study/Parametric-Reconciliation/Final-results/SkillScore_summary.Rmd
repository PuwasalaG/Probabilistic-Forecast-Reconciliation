---
title: "Skill Scores - Summary"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
```

1. \textbf{Without Optimal method -} Choosing a rolling window of 500 observations we generate reconciled forecast distributions for h=1,2,3 and only BU, OLS, WLS, and MinT methods were used for reconciliation.

2. \textbf{With Optimal G - Setup 1:} Here I choose an outer rolling window of 603 observations. Inside this, we choose an inner rolling window of 500 observations from which I produce incoherent prob. forecasts. Then roll the inner rolling window, 1 step ahead for 100 times and get 100 of such incoherent prob forecasts which are then used to learn optimal G. Finally we use this Optimal G along with other G matrices to reconcile the incoherent forecasts obtained by moving the inner rolling window another 1-step ahead. So in this setup, we will lose the first 100 observations in the evaluation.

3. \textbf{With Optimal G - Setup 2:} Here we choose an outer rolling window of 500 observations. Fit models and obtain reconciled prob forecasts using different G matrices including optimal G. The Optimal G matrix is learned using an inner rolling window of 398 observations and moving this window for 100 times within the outer rolling window. Here we do not lose any observations in evaluations. Therefore the scores from BU, OLS, WLS, and MinT are similar to those from 1.

# Without Optimal Method

 
```{r echo=FALSE}
##########################
   ### Gaussian DGP ###
##########################

###--Full Hierarchy--###


DF_MultiV_Full_GausDGP_W.o_Optim <- read.csv("Without-Optimal/DF_MultiV_Full_GaussianDGP.csv")[,-1]


DF_MultiV_Full_GausDGP_W.o_Optim %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.ES = mean(`Energy.score`), 
            E.VS = mean(`Variogram.score`)) -> DF_MultiV_Full_GausDGP_W.o_Optim

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Full_GausDGP_W.o_Optim %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Bottom up") -> DF_MultScores_AllTS_GausDGP_W.o_Optim



##--Calculate the skill scores--# 


DF_MultScores_AllTS_GausDGP_W.o_Optim %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.ES`) %>% as_vector() -> BU_E.ES_AllTS_GausDGP_W.o_Optim 

DF_MultScores_AllTS_GausDGP_W.o_Optim %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.VS`) %>% 
  as_vector() -> BU_E.VS_AllTS_GausDGP_W.o_Optim  


DF_MultScores_AllTS_GausDGP_W.o_Optim %>% 
  mutate(SS_E.ES = round((1-(`E.ES`/BU_E.ES_AllTS_GausDGP_W.o_Optim))*100, digits = 2),
         SS_E.VS = round((1-(`E.VS`/BU_E.VS_AllTS_GausDGP_W.o_Optim))*100, digits = 2)) -> DF_MultScore_SS_AllTS_GausDGP_W.o_Optim

DF_MultScore_SS_AllTS_GausDGP_W.o_Optim %>%  
  dplyr::select(-`E.ES`, -`E.VS`) -> DF_MultScore_SS_AllTS_GausDGP_W.o_Optim


# DF_MultScore_SS_AllTS_GausDGP_W.o_Optim %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.VS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.ES`) -> SS_E.ES_AllTS_GausDGP_W.o_Optim
# 
# DF_MultScore_SS_AllTS_GausDGP_W.o_Optim %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.ES`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.VS`) -> SS_E.VS_AllTS_GausDGP_W.o_Optim

# View(SS_E.ES_AllTS_GausDGP_W.o_Optim)
# View(SS_E.VS_AllTS_GausDGP_W.o_Optim)



###--Bottom level of the Hierarchy--###



DF_MultiV_Bot_GausDGP_W.o_Optim <- read.csv("Without-Optimal/DF_MultiV_Bot_GaussianDGP.csv")[,-1]


DF_MultiV_Bot_GausDGP_W.o_Optim %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.LS = mean(`Log.score`)) -> DF_MultiV_Bot_GausDGP_W.o_Optim

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Bot_GausDGP_W.o_Optim %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Base") -> DF_MultScores_BotTS_GausDGP_W.o_Optim

##--Calculate the skill scores--# 

DF_MultScores_BotTS_GausDGP_W.o_Optim %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.LS`) %>% 
  as_vector() -> BU_E.LS_BotTS_GausDGP_W.o_Optim

DF_MultScores_BotTS_GausDGP_W.o_Optim %>% 
  mutate(SS_E.LS = round((1-(`E.LS`/BU_E.LS_BotTS_GausDGP_W.o_Optim))*100, digits = 2)) -> DF_MultScore_SS_BotTS_GausDGP_W.o_Optim

# DF_MultScore_SS_BotTS_GausDGP_W.o_Optim %>%  
#   dplyr::select(-`E.LS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.LS`) -> SS_E.LS_BotTS_GausDGP_W.o_Optim

# View(SS_E.LS_BotTS_GausDGP_W.o_Optim)


DF_MultScore_SS_BotTS_GausDGP_W.o_Optim %>% 
  ungroup() %>% 
  pull(SS_E.LS) -> SS_E.LS_GausDGP_W.o_Optim

DF_MultScore_SS_AllTS_GausDGP_W.o_Optim %>% 
  ungroup() %>% 
  add_column(SS_E.LS = SS_E.LS_GausDGP_W.o_Optim) -> SkillScore_full_hier_GausDGP_W.o_Optim


###############################
   ###--Non-Gauss DGP--###
###############################

DF_MultiV_Full_NonGaussDGP_W.o_Optim <- read.csv("Without-Optimal/DF_MultiV_Full_NonGaussianDGP.csv")[,-1]


DF_MultiV_Full_NonGaussDGP_W.o_Optim %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.ES = mean(`Energy.score`), 
            E.VS = mean(`Variogram.score`)) -> DF_MultiV_Full_NonGaussDGP_W.o_Optim

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Full_NonGaussDGP_W.o_Optim %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Bottom up") -> DF_MultScores_AllTS_NonGaussDGP_W.o_Optim



##--Calculate the skill scores--# 


DF_MultScores_AllTS_NonGaussDGP_W.o_Optim %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.ES`) %>% as_vector() -> BU_E.ES_AllTS_NonGaussDGP_W.o_Optim 

DF_MultScores_AllTS_NonGaussDGP_W.o_Optim %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.VS`) %>% 
  as_vector() -> BU_E.VS_AllTS_NonGaussDGP_W.o_Optim  


DF_MultScores_AllTS_NonGaussDGP_W.o_Optim %>% 
  mutate(SS_E.ES = round((1-(`E.ES`/BU_E.ES_AllTS_NonGaussDGP_W.o_Optim))*100, digits = 2),
         SS_E.VS = round((1-(`E.VS`/BU_E.VS_AllTS_NonGaussDGP_W.o_Optim))*100, digits = 2)) -> DF_MultScore_SS_AllTS_NonGaussDGP_W.o_Optim

DF_MultScore_SS_AllTS_NonGaussDGP_W.o_Optim %>%  
  dplyr::select(-`E.ES`, -`E.VS`) -> DF_MultScore_SS_AllTS_NonGaussDGP_W.o_Optim


# DF_MultScore_SS_AllTS_NonGaussDGP_W.o_Optim %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.VS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.ES`) -> SS_E.ES_AllTS_NonGaussDGP_W.o_Optim
# 
# DF_MultScore_SS_AllTS_NonGaussDGP_W.o_Optim %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.ES`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.VS`) -> SS_E.VS_AllTS_NonGaussDGP_W.o_Optim

# View(SS_E.ES_AllTS_NonGaussDGP_W.o_Optim)
# View(SS_E.VS_AllTS_NonGaussDGP_W.o_Optim)



###--Bottom level of the Hierarchy--###



DF_MultiV_Bot_NonGaussDGP_W.o_Optim <- read.csv("Without-Optimal/DF_MultiV_Bot_NonGaussianDGP.csv")[,-1]


DF_MultiV_Bot_NonGaussDGP_W.o_Optim %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.LS = mean(`Log.score`)) -> DF_MultiV_Bot_NonGaussDGP_W.o_Optim

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Bot_NonGaussDGP_W.o_Optim %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Base") -> DF_MultScores_BotTS_NonGaussDGP_W.o_Optim

##--Calculate the skill scores--# 

DF_MultScores_BotTS_NonGaussDGP_W.o_Optim %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.LS`) %>% 
  as_vector() -> BU_E.LS_BotTS_NonGaussDGP_W.o_Optim

DF_MultScores_BotTS_NonGaussDGP_W.o_Optim %>% 
  mutate(SS_E.LS = round((1-(`E.LS`/BU_E.LS_BotTS_NonGaussDGP_W.o_Optim))*100, digits = 2)) -> DF_MultScore_SS_BotTS_NonGaussDGP_W.o_Optim

# DF_MultScore_SS_BotTS_NonGaussDGP_W.o_Optim %>%  
#   dplyr::select(-`E.LS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.LS`) -> SS_E.LS_BotTS_NonGaussDGP_W.o_Optim

# View(SS_E.LS_BotTS_NonGaussDGP_W.o_Optim)


DF_MultScore_SS_BotTS_NonGaussDGP_W.o_Optim %>% 
  ungroup() %>% 
  pull(SS_E.LS) -> SS_E.LS_NonGaussDGP_W.o_Optim

DF_MultScore_SS_AllTS_NonGaussDGP_W.o_Optim %>% 
  ungroup() %>% 
  add_column(SS_E.LS = SS_E.LS_NonGaussDGP_W.o_Optim) -> SkillScore_full_hier_NonGaussDGP_W.o_Optim



SkillScore_full_hier_GausDGP_W.o_Optim %>% 
  gather(key = key, value = value, SS_E.ES, SS_E.VS, SS_E.LS) %>% 
  unite(temp, Forecast.Horizon, key) %>% 
  spread(key = temp, value = value) %>% 
  dplyr::select(R.method, `1_SS_E.LS`, `2_SS_E.LS`, `3_SS_E.LS`, 
         `1_SS_E.ES`, `2_SS_E.ES`, `3_SS_E.ES`, 
         `1_SS_E.VS`, `2_SS_E.VS`, `3_SS_E.VS`) %>% 
  rename("1" = `1_SS_E.LS`, "2" = `2_SS_E.LS`, "3" = `3_SS_E.LS`, 
         "1" = `1_SS_E.ES`, "2" = `2_SS_E.ES`, "3" = `3_SS_E.ES`, 
         "1" = `1_SS_E.VS`, "2" = `2_SS_E.VS`, "3" = `3_SS_E.VS`)%>% 
   kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "Log Score(%)" = 3, "Energy Score(%)" = 3, "Variogram Score(%)" = 3)) %>% 
  kableExtra::add_header_above(c("Gaussian DGP" = 10))

SkillScore_full_hier_NonGaussDGP_W.o_Optim %>% 
  gather(key = key, value = value, SS_E.ES, SS_E.VS, SS_E.LS) %>% 
  unite(temp, Forecast.Horizon, key) %>% 
  spread(key = temp, value = value) %>% 
  dplyr::select(R.method, `1_SS_E.LS`, `2_SS_E.LS`, `3_SS_E.LS`, 
         `1_SS_E.ES`, `2_SS_E.ES`, `3_SS_E.ES`, 
         `1_SS_E.VS`, `2_SS_E.VS`, `3_SS_E.VS`) %>% 
  rename("1" = `1_SS_E.LS`, "2" = `2_SS_E.LS`, "3" = `3_SS_E.LS`, 
         "1" = `1_SS_E.ES`, "2" = `2_SS_E.ES`, "3" = `3_SS_E.ES`, 
         "1" = `1_SS_E.VS`, "2" = `2_SS_E.VS`, "3" = `3_SS_E.VS`)%>% 
   kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "Log Score(%)" = 3, "Energy Score(%)" = 3, "Variogram Score(%)" = 3)) %>% 
  kableExtra::add_header_above(c("Non-Gaussian DGP" = 10))

```

# With Optimal G - Setup 1

```{r echo=FALSE}
##########################
   ### Gaussian DGP ###
##########################

###--Full Hierarchy--###


DF_MultiV_Full_GausDGP_Optim_M1 <- read.csv("OptimalG_M1/DF_MultiV_Full_GaussianDGP.csv")[,-1]


DF_MultiV_Full_GausDGP_Optim_M1 %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.ES = mean(`Energy.score`), 
            E.VS = mean(`Variogram.score`)) -> DF_MultiV_Full_GausDGP_Optim_M1

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Full_GausDGP_Optim_M1 %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Bottom up") -> DF_MultScores_AllTS_GausDGP_Optim_M1



##--Calculate the skill scores--# 


DF_MultScores_AllTS_GausDGP_Optim_M1 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.ES`) %>% as_vector() -> BU_E.ES_AllTS_GausDGP_Optim_M1 

DF_MultScores_AllTS_GausDGP_Optim_M1 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.VS`) %>% 
  as_vector() -> BU_E.VS_AllTS_GausDGP_Optim_M1  


DF_MultScores_AllTS_GausDGP_Optim_M1 %>% 
  mutate(SS_E.ES = round((1-(`E.ES`/BU_E.ES_AllTS_GausDGP_Optim_M1))*100, digits = 2),
         SS_E.VS = round((1-(`E.VS`/BU_E.VS_AllTS_GausDGP_Optim_M1))*100, digits = 2)) -> DF_MultScore_SS_AllTS_GausDGP_Optim_M1

DF_MultScore_SS_AllTS_GausDGP_Optim_M1 %>%  
  dplyr::select(-`E.ES`, -`E.VS`) -> DF_MultScore_SS_AllTS_GausDGP_Optim_M1


# DF_MultScore_SS_AllTS_GausDGP_Optim_M1 %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.VS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.ES`) -> SS_E.ES_AllTS_GausDGP_Optim_M1
# 
# DF_MultScore_SS_AllTS_GausDGP_Optim_M1 %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.ES`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.VS`) -> SS_E.VS_AllTS_GausDGP_Optim_M1

# View(SS_E.ES_AllTS_GausDGP_Optim_M1)
# View(SS_E.VS_AllTS_GausDGP_Optim_M1)



###--Bottom level of the Hierarchy--###



DF_MultiV_Bot_GausDGP_Optim_M1 <- read.csv("OptimalG_M1/DF_MultiV_Bot_GaussianDGP.csv")[,-1]


DF_MultiV_Bot_GausDGP_Optim_M1 %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.LS = mean(`Log.score`)) -> DF_MultiV_Bot_GausDGP_Optim_M1

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Bot_GausDGP_Optim_M1 %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Base") -> DF_MultScores_BotTS_GausDGP_Optim_M1

##--Calculate the skill scores--# 

DF_MultScores_BotTS_GausDGP_Optim_M1 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.LS`) %>% 
  as_vector() -> BU_E.LS_BotTS_GausDGP_Optim_M1

DF_MultScores_BotTS_GausDGP_Optim_M1 %>% 
  mutate(SS_E.LS = round((1-(`E.LS`/BU_E.LS_BotTS_GausDGP_Optim_M1))*100, digits = 2)) -> DF_MultScore_SS_BotTS_GausDGP_Optim_M1

# DF_MultScore_SS_BotTS_GausDGP_Optim_M1 %>%  
#   dplyr::select(-`E.LS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.LS`) -> SS_E.LS_BotTS_GausDGP_Optim_M1

# View(SS_E.LS_BotTS_GausDGP_Optim_M1)


DF_MultScore_SS_BotTS_GausDGP_Optim_M1 %>% 
  ungroup() %>% 
  pull(SS_E.LS) -> SS_E.LS_GausDGP_Optim_M1

DF_MultScore_SS_AllTS_GausDGP_Optim_M1 %>% 
  ungroup() %>% 
  add_column(SS_E.LS = SS_E.LS_GausDGP_Optim_M1) -> SkillScore_full_hier_GausDGP_Optim_M1


###############################
###--Non-Gauss DGP--###
###############################

DF_MultiV_Full_NonGaussDGP_Optim_M1 <- read.csv("OptimalG_M1/DF_MultiV_Full_NonGaussianDGP.csv")[,-1]


DF_MultiV_Full_NonGaussDGP_Optim_M1 %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.ES = mean(`Energy.score`), 
            E.VS = mean(`Variogram.score`)) -> DF_MultiV_Full_NonGaussDGP_Optim_M1

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Full_NonGaussDGP_Optim_M1 %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Bottom up") -> DF_MultScores_AllTS_NonGaussDGP_Optim_M1



##--Calculate the skill scores--# 


DF_MultScores_AllTS_NonGaussDGP_Optim_M1 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.ES`) %>% as_vector() -> BU_E.ES_AllTS_NonGaussDGP_Optim_M1 

DF_MultScores_AllTS_NonGaussDGP_Optim_M1 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.VS`) %>% 
  as_vector() -> BU_E.VS_AllTS_NonGaussDGP_Optim_M1  


DF_MultScores_AllTS_NonGaussDGP_Optim_M1 %>% 
  mutate(SS_E.ES = round((1-(`E.ES`/BU_E.ES_AllTS_NonGaussDGP_Optim_M1))*100, digits = 2),
         SS_E.VS = round((1-(`E.VS`/BU_E.VS_AllTS_NonGaussDGP_Optim_M1))*100, digits = 2)) -> DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M1

DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M1 %>%  
  dplyr::select(-`E.ES`, -`E.VS`) -> DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M1


# DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M1 %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.VS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.ES`) -> SS_E.ES_AllTS_NonGaussDGP_Optim_M1
# 
# DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M1 %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.ES`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.VS`) -> SS_E.VS_AllTS_NonGaussDGP_Optim_M1

# View(SS_E.ES_AllTS_NonGaussDGP_Optim_M1)
# View(SS_E.VS_AllTS_NonGaussDGP_Optim_M1)



###--Bottom level of the Hierarchy--###



DF_MultiV_Bot_NonGaussDGP_Optim_M1 <- read.csv("OptimalG_M1/DF_MultiV_Bot_NonGaussianDGP.csv")[,-1]


DF_MultiV_Bot_NonGaussDGP_Optim_M1 %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.LS = mean(`Log.score`)) -> DF_MultiV_Bot_NonGaussDGP_Optim_M1

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Bot_NonGaussDGP_Optim_M1 %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Base") -> DF_MultScores_BotTS_NonGaussDGP_Optim_M1

##--Calculate the skill scores--# 

DF_MultScores_BotTS_NonGaussDGP_Optim_M1 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.LS`) %>% 
  as_vector() -> BU_E.LS_BotTS_NonGaussDGP_Optim_M1

DF_MultScores_BotTS_NonGaussDGP_Optim_M1 %>% 
  mutate(SS_E.LS = round((1-(`E.LS`/BU_E.LS_BotTS_NonGaussDGP_Optim_M1))*100, digits = 2)) -> DF_MultScore_SS_BotTS_NonGaussDGP_Optim_M1

# DF_MultScore_SS_BotTS_NonGaussDGP_Optim_M1 %>%  
#   dplyr::select(-`E.LS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.LS`) -> SS_E.LS_BotTS_NonGaussDGP_Optim_M1

# View(SS_E.LS_BotTS_NonGaussDGP_Optim_M1)


DF_MultScore_SS_BotTS_NonGaussDGP_Optim_M1 %>% 
  ungroup() %>% 
  pull(SS_E.LS) -> SS_E.LS_NonGaussDGP_Optim_M1

DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M1 %>% 
  ungroup() %>% 
  add_column(SS_E.LS = SS_E.LS_NonGaussDGP_Optim_M1) -> SkillScore_full_hier_NonGaussDGP_Optim_M1



SkillScore_full_hier_GausDGP_Optim_M1 %>% 
  gather(key = key, value = value, SS_E.ES, SS_E.VS, SS_E.LS) %>% 
  unite(temp, Forecast.Horizon, key) %>% 
  spread(key = temp, value = value) %>% 
  dplyr::select(R.method, `1_SS_E.LS`, `2_SS_E.LS`, `3_SS_E.LS`, 
                `1_SS_E.ES`, `2_SS_E.ES`, `3_SS_E.ES`, 
                `1_SS_E.VS`, `2_SS_E.VS`, `3_SS_E.VS`) %>% 
  rename("1" = `1_SS_E.LS`, "2" = `2_SS_E.LS`, "3" = `3_SS_E.LS`, 
         "1" = `1_SS_E.ES`, "2" = `2_SS_E.ES`, "3" = `3_SS_E.ES`, 
         "1" = `1_SS_E.VS`, "2" = `2_SS_E.VS`, "3" = `3_SS_E.VS`)%>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "Log Score(%)" = 3, "Energy Score(%)" = 3, "Variogram Score(%)" = 3)) %>% 
  kableExtra::add_header_above(c("Gaussian DGP" = 10))

SkillScore_full_hier_NonGaussDGP_Optim_M1 %>% 
  gather(key = key, value = value, SS_E.ES, SS_E.VS, SS_E.LS) %>% 
  unite(temp, Forecast.Horizon, key) %>% 
  spread(key = temp, value = value) %>% 
  dplyr::select(R.method, `1_SS_E.LS`, `2_SS_E.LS`, `3_SS_E.LS`, 
                `1_SS_E.ES`, `2_SS_E.ES`, `3_SS_E.ES`, 
                `1_SS_E.VS`, `2_SS_E.VS`, `3_SS_E.VS`) %>% 
  rename("1" = `1_SS_E.LS`, "2" = `2_SS_E.LS`, "3" = `3_SS_E.LS`, 
         "1" = `1_SS_E.ES`, "2" = `2_SS_E.ES`, "3" = `3_SS_E.ES`, 
         "1" = `1_SS_E.VS`, "2" = `2_SS_E.VS`, "3" = `3_SS_E.VS`)%>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "Log Score(%)" = 3, "Energy Score(%)" = 3, "Variogram Score(%)" = 3)) %>% 
  kableExtra::add_header_above(c("Non-Gaussian DGP" = 10))
```

# With Optimal G - Setup 2

In this set up we take a rolling window of 500 observations and the G is learned using a inner rolling window of 398 obervarions. We are not loosing any data points here. Therefore the scores from reconcilition methods except Optimal method are identical to the scores in `Without Optimal G`. 

```{r echo=FALSE}

##########################
### Gaussian DGP ###
##########################

###--Full Hierarchy--###


DF_MultiV_Full_GausDGP_Optim_M2 <- read.csv("OptimalG_M2/DF_MultiV_Full_GaussianDGP.csv")[,-1]


DF_MultiV_Full_GausDGP_Optim_M2 %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.ES = mean(`Energy.score`), 
            E.VS = mean(`Variogram.score`)) -> DF_MultiV_Full_GausDGP_Optim_M2

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Full_GausDGP_Optim_M2 %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Bottom up") -> DF_MultScores_AllTS_GausDGP_Optim_M2



##--Calculate the skill scores--# 


DF_MultScores_AllTS_GausDGP_Optim_M2 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.ES`) %>% as_vector() -> BU_E.ES_AllTS_GausDGP_Optim_M2 

DF_MultScores_AllTS_GausDGP_Optim_M2 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.VS`) %>% 
  as_vector() -> BU_E.VS_AllTS_GausDGP_Optim_M2  


DF_MultScores_AllTS_GausDGP_Optim_M2 %>% 
  mutate(SS_E.ES = round((1-(`E.ES`/BU_E.ES_AllTS_GausDGP_Optim_M2))*100, digits = 2),
         SS_E.VS = round((1-(`E.VS`/BU_E.VS_AllTS_GausDGP_Optim_M2))*100, digits = 2)) -> DF_MultScore_SS_AllTS_GausDGP_Optim_M2

DF_MultScore_SS_AllTS_GausDGP_Optim_M2 %>%  
  dplyr::select(-`E.ES`, -`E.VS`) -> DF_MultScore_SS_AllTS_GausDGP_Optim_M2


# DF_MultScore_SS_AllTS_GausDGP_Optim_M2 %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.VS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.ES`) -> SS_E.ES_AllTS_GausDGP_Optim_M2
# 
# DF_MultScore_SS_AllTS_GausDGP_Optim_M2 %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.ES`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.VS`) -> SS_E.VS_AllTS_GausDGP_Optim_M2

# View(SS_E.ES_AllTS_GausDGP_Optim_M2)
# View(SS_E.VS_AllTS_GausDGP_Optim_M2)



###--Bottom level of the Hierarchy--###



DF_MultiV_Bot_GausDGP_Optim_M2 <- read.csv("OptimalG_M2/DF_MultiV_Bot_GaussianDGP.csv")[,-1]


DF_MultiV_Bot_GausDGP_Optim_M2 %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.LS = mean(`Log.score`)) -> DF_MultiV_Bot_GausDGP_Optim_M2

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Bot_GausDGP_Optim_M2 %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Base") -> DF_MultScores_BotTS_GausDGP_Optim_M2

##--Calculate the skill scores--# 

DF_MultScores_BotTS_GausDGP_Optim_M2 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.LS`) %>% 
  as_vector() -> BU_E.LS_BotTS_GausDGP_Optim_M2

DF_MultScores_BotTS_GausDGP_Optim_M2 %>% 
  mutate(SS_E.LS = round((1-(`E.LS`/BU_E.LS_BotTS_GausDGP_Optim_M2))*100, digits = 2)) -> DF_MultScore_SS_BotTS_GausDGP_Optim_M2

# DF_MultScore_SS_BotTS_GausDGP_Optim_M2 %>%  
#   dplyr::select(-`E.LS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.LS`) -> SS_E.LS_BotTS_GausDGP_Optim_M2

# View(SS_E.LS_BotTS_GausDGP_Optim_M2)


DF_MultScore_SS_BotTS_GausDGP_Optim_M2 %>% 
  ungroup() %>% 
  pull(SS_E.LS) -> SS_E.LS_GausDGP_Optim_M2

DF_MultScore_SS_AllTS_GausDGP_Optim_M2 %>% 
  ungroup() %>% 
  add_column(SS_E.LS = SS_E.LS_GausDGP_Optim_M2) -> SkillScore_full_hier_GausDGP_Optim_M2


###############################
###--Non-Gauss DGP--###
###############################

DF_MultiV_Full_NonGaussDGP_Optim_M2 <- read.csv("OptimalG_M2/DF_MultiV_Full_NonGaussianDGP.csv")[,-1]


DF_MultiV_Full_NonGaussDGP_Optim_M2 %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.ES = mean(`Energy.score`), 
            E.VS = mean(`Variogram.score`)) -> DF_MultiV_Full_NonGaussDGP_Optim_M2

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Full_NonGaussDGP_Optim_M2 %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Bottom up") -> DF_MultScores_AllTS_NonGaussDGP_Optim_M2



##--Calculate the skill scores--# 


DF_MultScores_AllTS_NonGaussDGP_Optim_M2 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.ES`) %>% as_vector() -> BU_E.ES_AllTS_NonGaussDGP_Optim_M2 

DF_MultScores_AllTS_NonGaussDGP_Optim_M2 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.VS`) %>% 
  as_vector() -> BU_E.VS_AllTS_NonGaussDGP_Optim_M2  


DF_MultScores_AllTS_NonGaussDGP_Optim_M2 %>% 
  mutate(SS_E.ES = round((1-(`E.ES`/BU_E.ES_AllTS_NonGaussDGP_Optim_M2))*100, digits = 2),
         SS_E.VS = round((1-(`E.VS`/BU_E.VS_AllTS_NonGaussDGP_Optim_M2))*100, digits = 2)) -> DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M2

DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M2 %>%  
  dplyr::select(-`E.ES`, -`E.VS`) -> DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M2


# DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M2 %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.VS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.ES`) -> SS_E.ES_AllTS_NonGaussDGP_Optim_M2
# 
# DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M2 %>%  
#   dplyr::select(-`E.ES`, -`E.VS`, -`SS_E.ES`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.VS`) -> SS_E.VS_AllTS_NonGaussDGP_Optim_M2

# View(SS_E.ES_AllTS_NonGaussDGP_Optim_M2)
# View(SS_E.VS_AllTS_NonGaussDGP_Optim_M2)



###--Bottom level of the Hierarchy--###



DF_MultiV_Bot_NonGaussDGP_Optim_M2 <- read.csv("OptimalG_M2/DF_MultiV_Bot_NonGaussianDGP.csv")[,-1]


DF_MultiV_Bot_NonGaussDGP_Optim_M2 %>% 
  group_by(`F.method`, `R.method`, `Forecast.Horizon`) %>% 
  summarise(E.LS = mean(`Log.score`)) -> DF_MultiV_Bot_NonGaussDGP_Optim_M2

#DF_MultScores %>% dplyr::filter(`R.method` != "Base") -> DF_MultScore_Recon

DF_MultiV_Bot_NonGaussDGP_Optim_M2 %>% 
  dplyr::filter(`F.method`=="ARIMA" | `R.method`=="Base") -> DF_MultScores_BotTS_NonGaussDGP_Optim_M2

##--Calculate the skill scores--# 

DF_MultScores_BotTS_NonGaussDGP_Optim_M2 %>% 
  filter(`R.method`=="Bottom up") %>%
  slice() %>%
  ungroup() %>%
  dplyr::select(`E.LS`) %>% 
  as_vector() -> BU_E.LS_BotTS_NonGaussDGP_Optim_M2

DF_MultScores_BotTS_NonGaussDGP_Optim_M2 %>% 
  mutate(SS_E.LS = round((1-(`E.LS`/BU_E.LS_BotTS_NonGaussDGP_Optim_M2))*100, digits = 2)) -> DF_MultScore_SS_BotTS_NonGaussDGP_Optim_M2

# DF_MultScore_SS_BotTS_NonGaussDGP_Optim_M2 %>%  
#   dplyr::select(-`E.LS`) %>%
#   spread(key = `Forecast.Horizon`, value = `SS_E.LS`) -> SS_E.LS_BotTS_NonGaussDGP_Optim_M2

# View(SS_E.LS_BotTS_NonGaussDGP_Optim_M2)


DF_MultScore_SS_BotTS_NonGaussDGP_Optim_M2 %>% 
  ungroup() %>% 
  pull(SS_E.LS) -> SS_E.LS_NonGaussDGP_Optim_M2

DF_MultScore_SS_AllTS_NonGaussDGP_Optim_M2 %>% 
  ungroup() %>% 
  add_column(SS_E.LS = SS_E.LS_NonGaussDGP_Optim_M2) -> SkillScore_full_hier_NonGaussDGP_Optim_M2



SkillScore_full_hier_GausDGP_Optim_M2 %>% 
  gather(key = key, value = value, SS_E.ES, SS_E.VS, SS_E.LS) %>% 
  unite(temp, Forecast.Horizon, key) %>% 
  spread(key = temp, value = value) %>% 
  dplyr::select(R.method, `1_SS_E.LS`, `2_SS_E.LS`, `3_SS_E.LS`, 
                `1_SS_E.ES`, `2_SS_E.ES`, `3_SS_E.ES`, 
                `1_SS_E.VS`, `2_SS_E.VS`, `3_SS_E.VS`) %>% 
  rename("1" = `1_SS_E.LS`, "2" = `2_SS_E.LS`, "3" = `3_SS_E.LS`, 
         "1" = `1_SS_E.ES`, "2" = `2_SS_E.ES`, "3" = `3_SS_E.ES`, 
         "1" = `1_SS_E.VS`, "2" = `2_SS_E.VS`, "3" = `3_SS_E.VS`)%>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "Log Score(%)" = 3, "Energy Score(%)" = 3, "Variogram Score(%)" = 3)) %>% 
  kableExtra::add_header_above(c("Gaussian DGP" = 10))

SkillScore_full_hier_NonGaussDGP_Optim_M2 %>% 
  gather(key = key, value = value, SS_E.ES, SS_E.VS, SS_E.LS) %>% 
  unite(temp, Forecast.Horizon, key) %>% 
  spread(key = temp, value = value) %>% 
  dplyr::select(R.method, `1_SS_E.LS`, `2_SS_E.LS`, `3_SS_E.LS`, 
                `1_SS_E.ES`, `2_SS_E.ES`, `3_SS_E.ES`, 
                `1_SS_E.VS`, `2_SS_E.VS`, `3_SS_E.VS`) %>% 
  rename("1" = `1_SS_E.LS`, "2" = `2_SS_E.LS`, "3" = `3_SS_E.LS`, 
         "1" = `1_SS_E.ES`, "2" = `2_SS_E.ES`, "3" = `3_SS_E.ES`, 
         "1" = `1_SS_E.VS`, "2" = `2_SS_E.VS`, "3" = `3_SS_E.VS`)%>% 
  kable(format = "latex") %>% kable_styling("striped") %>% 
  kableExtra::add_header_above(c(" " = 1, "Log Score(%)" = 3, "Energy Score(%)" = 3, "Variogram Score(%)" = 3)) %>% 
  kableExtra::add_header_above(c("Non-Gaussian DGP" = 10))

```

